
SHELL=/bin/sh

.SUFFIXES: .cpp .o .so

VERSION=@PACKAGE_VERSION@
BINARY_VERSION=@BINARY_VERSION@

SONAME=libspep.so.$(BINARY_VERSION)

XERCESPATH=@XERCESPATH@
XMLSECPATH=@XMLSECPATH@
SAML2CPPPATH=@SAML2CPPPATH@
SPEPCPPPATH=@SPEPCPPPATH@
ICUPATH=@ICUPATH@
AXIS2PATH=@AXIS2PATH@

ifneq "$(XERCESPATH)" ""
XERCESLIB=-L$(XERCESPATH)/lib
XERCESINCLUDE=-I$(XERCESPATH)/include
endif

ifneq "$(XMLSECPATH)" ""
XMLSECLIB=-L$(XMLSECPATH)/lib
XMLSECINCLUDE=-I$(XMLSECPATH)/include
endif

ifneq "$(SAML2CPPPATH)" ""
SAML2CPPLIB=-L$(SAML2CPPPATH)/build
SAML2CPPINCLUDE=-I$(SAML2CPPPATH)/includes -I$(SAML2CPPPATH)/src-gen
endif

ifneq "$(ICUPATH)" ""
ICULIB=-L$(ICUPATH)/lib
ICUINCLUDE=-I$(ICUPATH)/include
endif

ifneq "$(AXIS2PATH)" ""
AXIS2LIB=-L$(AXIS2PATH)/lib
AXIS2INCLUDE=-I$(AXIS2PATH)/include/axis2-1.0
endif

CFLAGS=@CFLAGS@
CPPFLAGS=@CPPFLAGS@
CXXFLAGS=@CXXFLAGS@
DEFS=@DEFS@
LDFLAGS=@LDFLAGS@
LIBS=@LIBS@
INCLUDES=-I@srcdir@/includes $(SAML2CPPINCLUDE) $(XERCESINCLUDE) $(XMLSECINCLUDE) $(ICUINCLUDE) $(AXIS2INCLUDE)

# xx Edit here for other toolsets xx
SHLIB_CXXFLAGS=-fPIC -DPIC=1
SHLIB_LDFLAGS=-shared -Wl,-soname,$(SONAME)
LIBPREFIX=lib
LIBSUFFIX=.so

LIBNAME=$(LIBPREFIX)spep$(LIBSUFFIX)

INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
MKDIR_P=@MKDIR_P@
LN_S=@LN_S@

prefix=@prefix@
exec_prefix=@exec_prefix@

bindir=@bindir@
sbindir=@sbindir@
sysconfdir=@sysconfdir@
libdir=@libdir@

OUTDIR=@builddir@/build
SRCDIR=@srcdir@/src
INCDIR=@srcdir@/includes

DISTDIR=@builddir@/distribution
TARNAME=spep-$(VERSION)
DISTFILES=configure Makefile.in install-sh AUTHORS LICENSE NOTICE README spep.conf

BIN=$(OUTDIR)/$(SONAME)
OBJ= \
$(OUTDIR)/pep/PolicyEnforcementProcessorData.o \
$(OUTDIR)/pep/PolicyEnforcementProcessor.o \
$(OUTDIR)/pep/proxy/SessionGroupCacheProxy.o \
$(OUTDIR)/pep/proxy/SessionGroupCacheDispatcher.o \
$(OUTDIR)/pep/Decision.o \
$(OUTDIR)/pep/impl/SessionGroupCacheImpl.o \
$(OUTDIR)/ws/WSProcessor.o \
$(OUTDIR)/ws/WSProcessorData.o \
$(OUTDIR)/ws/WSClient.o \
$(OUTDIR)/ws/SOAPUtil.o \
$(OUTDIR)/UnicodeStringConversion.o \
$(OUTDIR)/identifier/proxy/IdentifierCacheProxy.o \
$(OUTDIR)/identifier/proxy/IdentifierCacheDispatcher.o \
$(OUTDIR)/authn/AuthnProcessor.o \
$(OUTDIR)/authn/AuthnProcessorData.o \
$(OUTDIR)/config/SPEPConfigData.o \
$(OUTDIR)/config/proxy/ConfigurationProxy.o \
$(OUTDIR)/config/proxy/ConfigurationDispatcher.o \
$(OUTDIR)/config/ConfigurationReader.o \
$(OUTDIR)/config/impl/ConfigurationImpl.o \
$(OUTDIR)/reporting/LocalReportingProcessor.o \
$(OUTDIR)/reporting/ReportingProcessor.o \
$(OUTDIR)/reporting/ReportingLevels.o \
$(OUTDIR)/SPEP.o \
$(OUTDIR)/sessions/UnauthenticatedSession.o \
$(OUTDIR)/sessions/SessionCacheThread.o \
$(OUTDIR)/sessions/PrincipalSession.o \
$(OUTDIR)/sessions/proxy/SessionCacheProxy.o \
$(OUTDIR)/sessions/proxy/SessionCacheDispatcher.o \
$(OUTDIR)/sessions/impl/SessionCacheImpl.o \
$(OUTDIR)/startup/proxy/StartupProcessorProxy.o \
$(OUTDIR)/startup/proxy/StartupProcessorDispatcher.o \
$(OUTDIR)/startup/impl/StartupProcessorImpl.o \
$(OUTDIR)/ipc/Dispatcher.o \
$(OUTDIR)/ipc/Engine.o \
$(OUTDIR)/ipc/Socket.o \
$(OUTDIR)/ipc/MessageHeader.o \
$(OUTDIR)/exceptions/AuthnException.o \
$(OUTDIR)/exceptions/AttributeException.o \
$(OUTDIR)/exceptions/PEPException.o \
$(OUTDIR)/exceptions/WSException.o \
$(OUTDIR)/exceptions/InvalidStateException.o \
$(OUTDIR)/exceptions/SPEPStartupException.o \
$(OUTDIR)/exceptions/InvalidRequestException.o \
$(OUTDIR)/exceptions/KeyResolverException.o \
$(OUTDIR)/exceptions/MetadataException.o \
$(OUTDIR)/exceptions/InvalidResponseException.o \
$(OUTDIR)/metadata/KeyResolver.o \
$(OUTDIR)/metadata/MetadataThread.o \
$(OUTDIR)/metadata/proxy/MetadataDispatcher.o \
$(OUTDIR)/metadata/proxy/MetadataProxy.o \
$(OUTDIR)/metadata/impl/MetadataImpl.o \
$(OUTDIR)/attribute/AttributeProcessorData.o \
$(OUTDIR)/attribute/AttributeProcessor.o \


OBJDIRS= \
$(OUTDIR) \
$(OUTDIR)/pep \
$(OUTDIR)/pep/proxy \
$(OUTDIR)/pep/impl \
$(OUTDIR)/ws \
$(OUTDIR)/identifier/proxy \
$(OUTDIR)/authn \
$(OUTDIR)/config \
$(OUTDIR)/config/proxy \
$(OUTDIR)/config/impl \
$(OUTDIR)/reporting \
$(OUTDIR)/sessions \
$(OUTDIR)/sessions/proxy \
$(OUTDIR)/sessions/impl \
$(OUTDIR)/startup \
$(OUTDIR)/startup/proxy \
$(OUTDIR)/startup/impl \
$(OUTDIR)/ipc \
$(OUTDIR)/exceptions \
$(OUTDIR)/metadata \
$(OUTDIR)/metadata/proxy \
$(OUTDIR)/metadata/impl \
$(OUTDIR)/attribute

all: prepare $(BIN)
	$(LN_S) $(SONAME) $(OUTDIR)/$(LIBNAME)

install: installdirs all
	$(INSTALL) $(BIN) $(DESTDIR)$(libdir)
	$(LN_S) $(SONAME) $(DESTDIR)$(libdir)/$(LIBNAME)
	if test ! -e $(DESTDIR)$(sysconfdir)/spep/spep.conf; then $(INSTALL_DATA) spep.conf $(DESTDIR)$(sysconfdir)/spep/; fi
	
installdirs:
	$(MKDIR_P) $(DESTDIR)$(libdir) $(DESTDIR)$(sysconfdir)/spep

dist:
	$(MKDIR_P) $(DISTDIR)/$(TARNAME)
	cp -frt $(DISTDIR)/$(TARNAME) $(SRCDIR) $(INCDIR) $(DISTFILES)
	tar zc -C $(DISTDIR) -f $(TARNAME).tar.gz --exclude .svn --no-anchored $(TARNAME)

clean:
	rm -f $(BIN) $(OBJ)

$(BIN): $(OBJ)
	$(CXX) $(LDFLAGS) $(SHLIB_LDFLAGS) -o $@ $(OBJ)

prepare:
	$(MKDIR_P) $(OBJDIRS)

$(OUTDIR)/%.o: $(SRCDIR)/%.cpp
	$(CXX) $(CXXFLAGS) $(SHLIB_CXXFLAGS) $(INCLUDES) -c -o $@ $<

